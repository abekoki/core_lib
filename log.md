# 開発ログ

## ===2025-07-31===

### 顔向き推定アルゴリズムの改善

**作業内容:**
- 参考サイト（https://zenn.dev/ykesamaru/articles/025b0eabf24e20）の手法に基づいて顔向き推定を実装
- 行列計算を使わない簡易的な手法に変更
- roll（傾き）の推定を削除し、yaw（左右）とpitch（上下）のみを推定

**実装した手法:**
1. **両目を結ぶ直線の分析**: 水平線との角度から左右の向きを推定
2. **三角形の分析**: 左目、右目、鼻先を結ぶ三角形の重心と鼻先の位置関係から顔の向きを推定
3. **鼻筋の直線の分析**: 鼻根から鼻先へのベクトルの角度から上下の向きを推定

**主な変更点:**
- `estimate_pose()`関数を`estimate_pose_simple()`に置き換え
- 行列計算（PnP、回転行列）を削除
- 幾何学的な計算のみで顔向きを推定
- 矢印による視覚的な表示機能を追加
- 三角形の描画機能を追加

**技術的詳細:**
- Yaw（左右）: 鼻先が三角形の重心から左右にずれる度合いで計算（±45度制限）
- Pitch（上下）: 鼻筋の角度から計算（±30度制限）
- 信頼度: 三角形の面積を正規化して計算

**ファイル変更:**
- `eye_detection.py`: 顔向き推定アルゴリズムを完全に書き換え

**次のステップ:**
- 実機テストによる動作確認
- 必要に応じてパラメータ調整

### 顔向き推定の改善（2回目）

**作業内容:**
- pitchが30度で固定される問題を修正
- 三角形の面の法線ベクトルを算出する機能を追加

**修正内容:**
1. **pitch計算の改善**: 固定値30を削除し、±45度の範囲で動的に計算するように変更
2. **法線ベクトル計算**: 三角形の2つの辺ベクトルから外積を使って法線ベクトルを算出
3. **視覚的表示**: 法線ベクトルを赤色の矢印で表示
4. **情報表示**: 法線ベクトルの値を画面上に表示

**技術的詳細:**
- 法線ベクトル: 三角形の辺ベクトルの外積で計算（2Dなのでz成分のみ）
- 正規化: 法線ベクトルの大きさで正規化して-1から1の範囲に
- 表示: 三角形の重心から法線ベクトルの方向に赤色矢印で表示

**ファイル変更:**
- `eye_detection.py`: pitch計算の修正、法線ベクトル計算機能の追加

### 顔向き推定の改善（3回目）

**作業内容:**
- pitchが45度で固定される問題を修正
- より動的で正確なpitch計算アルゴリズムを実装

**修正内容:**
1. **pitch計算の根本的改善**: 固定値45を削除し、両目の中心と鼻先の関係から動的に計算
2. **複数要素の組み合わせ**: 鼻筋の角度と鼻の長さを組み合わせてpitchを計算
3. **デバッグ情報の追加**: pitch計算過程の値を画面上に表示
4. **計算式の改善**: `pitch_angle_offset * 25 * normalized_nose_length`で動的計算

**技術的詳細:**
- **両目の中心と鼻先の関係**: 両目の中心から鼻先への角度を計算
- **基準角度**: 正面を向いている時は約-90度を基準として正規化
- **鼻の長さ正規化**: 両目の距離で正規化して顔の大きさに依存しないように
- **動的範囲**: ±45度の範囲で動的に変化

**ファイル変更:**
- `eye_detection.py`: pitch計算アルゴリズムの完全な書き換え、デバッグ情報の追加

### 顔向き推定の改善（4回目）

**作業内容:**
- pitch角の計算方法を根本的に修正
- 三角形の法線ベクトルの高さ方向成分を使用したpitch角計算を実装

**修正内容:**
1. **pitch計算の根本的変更**: 三角形の法線ベクトルの高さ方向成分からpitch角を計算
2. **高さ方向成分の計算**: 重心から鼻先へのベクトルと重心から両目の中心へのベクトルの外積で計算
3. **方向性の調整**: 上を向くと正、下を向くと負の値になるように調整
4. **視覚的表示の追加**: 高さ方向成分を緑色の矢印で表示

**技術的詳細:**
- **高さ方向成分**: `height_component = center_to_nose_x * center_to_eye_y - center_to_nose_y * center_to_eye_x`
- **正規化**: ベクトルの大きさで正規化して-1から1の範囲に
- **pitch角**: `pitch = normalized_height * 45`で±45度の範囲に制限
- **方向性**: 上向き=正、下向き=負

**視覚的表示:**
- **赤色矢印**: 三角形の法線ベクトル
- **緑色矢印**: 高さ方向成分（pitch角の計算に使用）

**ファイル変更:**
- `eye_detection.py`: pitch計算アルゴリズムの完全な書き換え、高さ方向成分の視覚化追加

### 顔向き推定の改善（5回目）

**作業内容:**
- GitHubサンプルコード（https://github.com/yKesamaru/Estimate_face_orientation）の手法に合わせて実装を修正
- 現在の実装とサンプルコードの違いを確認し、統一

**修正内容:**
1. **Yaw計算の修正**: 三角形の重心と鼻の頂点のX軸上の距離を直接使用
2. **Pitch計算の修正**: 三角形の重心と鼻の頂点のY軸上の距離を直接使用
3. **矢印描画の修正**: 方向ベクトルをX軸・Y軸に制限
4. **計算式の統一**: サンプルコードと同じ計算方法に変更

**技術的詳細:**
- **Yaw計算**: `distance_x = nose_tip[0] - triangle_center[0]` → `yaw = distance_x * 0.5`
- **Pitch計算**: `distance_y = nose_tip[1] - triangle_center[1]` → `pitch = distance_y * 0.5`
- **矢印描画**: X軸方向とY軸方向に制限されたベクトルで描画
- **上限設定**: 矢印の長さは100pxを上限とする

**サンプルコードとの違い:**
- **従来**: 複雑な法線ベクトル計算と角度変換
- **修正後**: シンプルな距離計算と直接的な角度変換

**ファイル変更:**
- `eye_detection.py`: サンプルコードの手法に合わせた完全な書き換え

### 顔向き推定の改善（6回目）

**作業内容:**
- pitch角の方向性を修正（上向き=正、下向き=負）

**修正内容:**
1. **pitch計算の方向性修正**: 画像座標系のY軸方向を考慮して符号を反転
2. **矢印描画の方向性修正**: 視覚的な矢印の方向も正しい方向に修正

**技術的詳細:**
- **画像座標系**: Y軸が下向きが正のため、計算時に符号を反転
- **pitch計算**: `distance_y = triangle_center[1] - nose_tip_px[1]`（符号反転）
- **矢印描画**: `pitch_direction = [0, -pitch_arrow_length]`（Y軸符号反転）
- **方向性**: 上向き=正の値、下向き=負の値

**修正理由:**
- 画像座標系ではY軸が下向きが正のため、上向きの顔の向きが負の値になっていた
- 直感的な方向性（上向き=正、下向き=負）に修正

**ファイル変更:**
- `eye_detection.py`: pitch角の方向性修正 