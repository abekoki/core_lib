# 開発ログ

## ===2025-07-31===

### 顔向き推定アルゴリズムの改善

**作業内容:**
- 参考サイト（https://zenn.dev/ykesamaru/articles/025b0eabf24e20）の手法に基づいて顔向き推定を実装
- 行列計算を使わない簡易的な手法に変更
- roll（傾き）の推定を削除し、yaw（左右）とpitch（上下）のみを推定

**実装した手法:**
1. **両目を結ぶ直線の分析**: 水平線との角度から左右の向きを推定
2. **三角形の分析**: 左目、右目、鼻先を結ぶ三角形の重心と鼻先の位置関係から顔の向きを推定
3. **鼻筋の直線の分析**: 鼻根から鼻先へのベクトルの角度から上下の向きを推定

**主な変更点:**
- `estimate_pose()`関数を`estimate_pose_simple()`に置き換え
- 行列計算（PnP、回転行列）を削除
- 幾何学的な計算のみで顔向きを推定
- 矢印による視覚的な表示機能を追加
- 三角形の描画機能を追加

**技術的詳細:**
- Yaw（左右）: 鼻先が三角形の重心から左右にずれる度合いで計算（±45度制限）
- Pitch（上下）: 鼻筋の角度から計算（±30度制限）
- 信頼度: 三角形の面積を正規化して計算

**ファイル変更:**
- `eye_detection.py`: 顔向き推定アルゴリズムを完全に書き換え

**次のステップ:**
- 実機テストによる動作確認
- 必要に応じてパラメータ調整

### 顔向き推定の改善（2回目）

**作業内容:**
- pitchが30度で固定される問題を修正
- 三角形の面の法線ベクトルを算出する機能を追加

**修正内容:**
1. **pitch計算の改善**: 固定値30を削除し、±45度の範囲で動的に計算するように変更
2. **法線ベクトル計算**: 三角形の2つの辺ベクトルから外積を使って法線ベクトルを算出
3. **視覚的表示**: 法線ベクトルを赤色の矢印で表示
4. **情報表示**: 法線ベクトルの値を画面上に表示

**技術的詳細:**
- 法線ベクトル: 三角形の辺ベクトルの外積で計算（2Dなのでz成分のみ）
- 正規化: 法線ベクトルの大きさで正規化して-1から1の範囲に
- 表示: 三角形の重心から法線ベクトルの方向に赤色矢印で表示

**ファイル変更:**
- `eye_detection.py`: pitch計算の修正、法線ベクトル計算機能の追加

### 顔向き推定の改善（3回目）

**作業内容:**
- pitchが45度で固定される問題を修正
- より動的で正確なpitch計算アルゴリズムを実装

**修正内容:**
1. **pitch計算の根本的改善**: 固定値45を削除し、両目の中心と鼻先の関係から動的に計算
2. **複数要素の組み合わせ**: 鼻筋の角度と鼻の長さを組み合わせてpitchを計算
3. **デバッグ情報の追加**: pitch計算過程の値を画面上に表示
4. **計算式の改善**: `pitch_angle_offset * 25 * normalized_nose_length`で動的計算

**技術的詳細:**
- **両目の中心と鼻先の関係**: 両目の中心から鼻先への角度を計算
- **基準角度**: 正面を向いている時は約-90度を基準として正規化
- **鼻の長さ正規化**: 両目の距離で正規化して顔の大きさに依存しないように
- **動的範囲**: ±45度の範囲で動的に変化

**ファイル変更:**
- `eye_detection.py`: pitch計算アルゴリズムの完全な書き換え、デバッグ情報の追加

### 顔向き推定の改善（4回目）

**作業内容:**
- pitch角の計算方法を根本的に修正
- 三角形の法線ベクトルの高さ方向成分を使用したpitch角計算を実装

**修正内容:**
1. **pitch計算の根本的変更**: 三角形の法線ベクトルの高さ方向成分からpitch角を計算
2. **高さ方向成分の計算**: 重心から鼻先へのベクトルと重心から両目の中心へのベクトルの外積で計算
3. **方向性の調整**: 上を向くと正、下を向くと負の値になるように調整
4. **視覚的表示の追加**: 高さ方向成分を緑色の矢印で表示

**技術的詳細:**
- **高さ方向成分**: `height_component = center_to_nose_x * center_to_eye_y - center_to_nose_y * center_to_eye_x`
- **正規化**: ベクトルの大きさで正規化して-1から1の範囲に
- **pitch角**: `pitch = normalized_height * 45`で±45度の範囲に制限
- **方向性**: 上向き=正、下向き=負

**視覚的表示:**
- **赤色矢印**: 三角形の法線ベクトル
- **緑色矢印**: 高さ方向成分（pitch角の計算に使用）

**ファイル変更:**
- `eye_detection.py`: pitch計算アルゴリズムの完全な書き換え、高さ方向成分の視覚化追加

### 顔向き推定の改善（5回目）

**作業内容:**
- GitHubサンプルコード（https://github.com/yKesamaru/Estimate_face_orientation）の手法に合わせて実装を修正
- 現在の実装とサンプルコードの違いを確認し、統一

**修正内容:**
1. **Yaw計算の修正**: 三角形の重心と鼻の頂点のX軸上の距離を直接使用
2. **Pitch計算の修正**: 三角形の重心と鼻の頂点のY軸上の距離を直接使用
3. **矢印描画の修正**: 方向ベクトルをX軸・Y軸に制限
4. **計算式の統一**: サンプルコードと同じ計算方法に変更

**技術的詳細:**
- **Yaw計算**: `distance_x = nose_tip[0] - triangle_center[0]` → `yaw = distance_x * 0.5`
- **Pitch計算**: `distance_y = nose_tip[1] - triangle_center[1]` → `pitch = distance_y * 0.5`
- **矢印描画**: X軸方向とY軸方向に制限されたベクトルで描画
- **上限設定**: 矢印の長さは100pxを上限とする

**サンプルコードとの違い:**
- **従来**: 複雑な法線ベクトル計算と角度変換
- **修正後**: シンプルな距離計算と直接的な角度変換

**ファイル変更:**
- `eye_detection.py`: サンプルコードの手法に合わせた完全な書き換え

### 顔向き推定の改善（6回目）

**作業内容:**
- pitch角の方向性を修正（上向き=正、下向き=負）

**修正内容:**
1. **pitch計算の方向性修正**: 画像座標系のY軸方向を考慮して符号を反転
2. **矢印描画の方向性修正**: 視覚的な矢印の方向も正しい方向に修正

**技術的詳細:**
- **画像座標系**: Y軸が下向きが正のため、計算時に符号を反転
- **pitch計算**: `distance_y = triangle_center[1] - nose_tip_px[1]`（符号反転）
- **矢印描画**: `pitch_direction = [0, -pitch_arrow_length]`（Y軸符号反転）
- **方向性**: 上向き=正の値、下向き=負の値

**修正理由:**
- 画像座標系ではY軸が下向きが正のため、上向きの顔の向きが負の値になっていた
- 直感的な方向性（上向き=正、下向き=負）に修正

**ファイル変更:**
- `eye_detection.py`: pitch角の方向性修正

### モジュール化と動画分析機能の追加

**作業内容:**
- eye_detection.pyをモジュール化
- 動画ファイルから検出結果をCSV出力する機能を実装
- mov_files.txtに記載の動画ファイルを一括分析

**実装内容:**
1. **eye_detection.pyのモジュール化**: メイン処理を`if __name__ == "__main__":`で囲み、外部から関数を呼び出せるように修正
2. **video_analysis.pyの作成**: 動画ファイル分析スクリプトを新規作成
3. **CSV出力機能**: 毎フレームの検出結果をCSVファイルに出力
4. **バッチ処理**: 複数動画ファイルの一括処理機能

**CSV出力項目:**
- frame: フレーム番号
- leye_openness: 左目の開瞼度
- reye_openness: 右目の開瞼度
- confidence: 信頼度
- face_yaw: 顔の左右の向き
- face_pitch: 顔の上下の向き
- nose_length: 鼻の長さ
- normal_vector: 三角形の法線ベクトル
- distance_x/y: X/Y軸方向の距離
- arrow_length/pitch_arrow_length: 矢印の長さ
- triangle_area: 三角形の面積
- eye_distance: 両目の距離

**技術的詳細:**
- **進捗表示**: 30フレームごとに進捗を表示
- **エラーハンドリング**: 動画ファイルが見つからない場合の警告
- **デフォルト値**: 顔が検出されないフレームは0.0で出力
- **出力ディレクトリ**: analysis_resultsディレクトリに自動保存

**ファイル変更:**
- `eye_detection.py`: モジュール化、triangle_areaとeye_distanceを返り値に追加
- `video_analysis.py`: 新規作成
- `run_analysis.bat`: 新規作成（実行用バッチファイル）
- `README.md`: 更新（新しい機能の説明を追加）

### 信頼度計算の改善

**作業内容:**
- 信頼度計算を目のランドマークとその周辺の情報から計算するように改善
- 安定度が低い場合や遮蔽が発生した場合に正しく信頼度を下げる機能を実装

**実装内容:**
1. **目のランドマークの可視性チェック**: z座標と座標範囲から遮蔽を検出
2. **目の対称性チェック**: 左右の目の開瞼度の差から安定性を評価
3. **目の位置関係チェック**: 両目の距離の妥当性を評価
4. **三角形の形状チェック**: 三角形の歪み度合いを評価
5. **重み付き総合信頼度**: 複数の要素を重み付きで統合

**信頼度計算要素:**
- **area_confidence (20%)**: 三角形の面積による基本信頼度
- **visibility_confidence (30%)**: ランドマークの可視性（遮蔽検出）
- **eye_symmetry (20%)**: 目の対称性（左右の開瞼度の差）
- **distance_confidence (15%)**: 目の距離の妥当性
- **shape_confidence (15%)**: 三角形の形状の妥当性

**技術的詳細:**
- **遮蔽検出**: z座標が負の値や座標範囲外の場合を遮蔽として判定
- **対称性評価**: `1.0 - |左目開瞼度 - 右目開瞼度| / (左目開瞼度 + 右目開瞼度)`
- **距離妥当性**: 画像幅に対する両目の距離比率が0.05-0.25の範囲内かチェック
- **形状妥当性**: 三角形の最短辺と最長辺の比率で歪みを評価

**CSV出力追加項目:**
- area_confidence: 面積による信頼度
- visibility_confidence: 可視性による信頼度
- eye_symmetry: 目の対称性
- distance_confidence: 距離による信頼度
- shape_confidence: 形状による信頼度
- eye_distance_ratio: 目の距離比率

**ファイル変更:**
- `eye_detection.py`: 信頼度計算アルゴリズムの完全な書き換え、詳細情報の追加
- `video_analysis.py`: 新しい信頼度詳細項目のCSV出力に対応

### 信頼度集約の改善

**作業内容:**
- 各信頼度要素をより効果的に集約し、最終的なconfidence列として出力する機能を改善
- 非線形補正と条件付き重み付けによる信頼度の精密化

**改善内容:**
1. **重みの調整**: 可視性の重みを35%に増加（最重要要素として）
2. **条件付き補正**: 各要素が閾値を下回った場合の信頼度大幅削減
3. **非線形補正**: 低信頼度・高信頼度での異なる評価基準
4. **詳細情報の追加**: 重み付き平均と最終信頼度の分離

**信頼度集約アルゴリズム:**
- **基本重み付き平均**: 各要素の重み付き合計
- **可視性補正**: 可視性<0.5の場合、全体信頼度×0.8
- **対称性補正**: 対称性<0.3の場合、全体信頼度×0.7
- **形状補正**: 形状<0.2の場合、全体信頼度×0.6
- **距離補正**: 距離<0.3の場合、全体信頼度×0.8
- **非線形最終補正**: 
  - 低信頼度(<0.3): さらに20%削減
  - 高信頼度(>0.8): 10%増加
  - 中程度: そのまま

**CSV出力追加項目:**
- weighted_confidence: 重み付き平均信頼度
- final_confidence: 最終補正後の信頼度

**技術的詳細:**
- **厳格な評価**: 問題のある要素がある場合の大幅な信頼度削減
- **段階的補正**: 複数の補正段階による精密な信頼度評価
- **非線形処理**: 信頼度レベルに応じた異なる評価基準

**ファイル変更:**
- `eye_detection.py`: 信頼度集約アルゴリズムの改善、詳細情報の追加
- `video_analysis.py`: 新しい信頼度詳細項目のCSV出力に対応

### 環境変数による設定管理の追加

**作業内容:**
- CSV出力先を.envファイルで指定できるように設定管理機能を追加
- 設定の一元化と柔軟性の向上

**実装内容:**
1. **config.pyの作成**: 環境変数と.envファイルの読み込み機能
2. **video_analysis.pyの修正**: 設定ファイルを使用するように変更
3. **設定項目の追加**: 出力ディレクトリ、動画ファイルパス、プレビュー表示、進捗間隔

**設定可能項目:**
- **OUTPUT_DIR**: CSVファイルの出力先ディレクトリ（デフォルト: analysis_results）
- **MOV_FILES_PATH**: 動画ファイルリストのパス（デフォルト: mov_files.txt）
- **SHOW_PREVIEW**: プレビュー表示の有無（デフォルト: false）
- **PROGRESS_INTERVAL**: 進捗表示間隔（デフォルト: 30フレーム）

**技術的詳細:**
- **環境変数優先**: システム環境変数が.envファイルより優先
- **デフォルト値**: 設定が存在しない場合の適切なデフォルト値
- **自動読み込み**: config.pyのインポート時に.envファイルを自動読み込み
- **型変換**: 文字列設定値を適切な型に変換

**使用方法:**
1. `.env`ファイルを作成
2. 必要な設定項目を記述
3. 設定ファイルが存在しない場合はデフォルト設定が使用

**ファイル変更:**
- `config.py`: 新規作成（設定管理モジュール）
- `video_analysis.py`: 設定ファイルの使用に対応
- `README.md`: 設定方法の説明を追加

### 目の遮蔽検出の強化

**作業内容:**
- 目の遮蔽画像でconfidenceが高くなっている問題を修正
- 遮蔽検出アルゴリズムの大幅な強化

**実装内容:**
1. **遮蔽検出の多層化**: より多くの目の周辺ランドマーク（25個）をチェック
2. **z座標異常値検出**: 遮蔽時のz座標の異常な分散を検出
3. **開瞼度による遮蔽検出**: 異常に低い開瞼度を遮蔽として判定
4. **左右目の差による遮蔽検出**: 左右の開瞼度の異常な差を検出
5. **信頼度大幅削減**: 遮蔽検出時の信頼度を最大90%削減

**遮蔽検出アルゴリズム:**
- **基本可視性**: 25個の目のランドマークの座標範囲チェック
- **z座標異常検出**: 標準偏差が0.1以上で異常として判定
- **開瞼度検出**: 最小開瞼度が0.1以下で遮蔽の可能性
- **左右差検出**: 左右の開瞼度差が0.05以上で異常
- **総合評価**: 4つの要素を重み付きで統合

**信頼度削減ロジック:**
- **軽度遮蔽**: 可視性<0.5の場合、信頼度×0.3
- **重度遮蔽**: 基本可視性<0.3またはz異常<0.2または開瞼度<0.2の場合、信頼度×0.1

**CSV出力追加項目:**
- basic_visibility: 基本的な可視性スコア
- z_anomaly_score: z座標異常値スコア
- eye_opening_score: 開瞼度による遮蔽スコア
- eye_difference_score: 左右目の差によるスコア

**技術的詳細:**
- **多層検出**: 単一の指標ではなく複数の指標で遮蔽を判定
- **厳格な削減**: 遮蔽検出時の大幅な信頼度削減
- **詳細情報**: 遮蔽検出の各段階の詳細をCSVに出力
- **リアルタイム対応**: 遮蔽の変化に応じた動的な信頼度調整

**ファイル変更:**
- `eye_detection.py`: 遮蔽検出アルゴリズムの完全な書き換え
- `video_analysis.py`: 新しい遮蔽検出詳細項目のCSV出力に対応 