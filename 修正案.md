了解しました！以下の仕様に基づき、目の開閉状態に関係なくサングラス装着時のみ信頼度を下げ、ROI（関心領域）のサイズを動的に決定する最終変更案をまとめます。輝度分析をベースにし、ROIサイズは顔のスケール（例: 目と目の距離）に応じて動的に設定します。これにより、目の開閉によるROIの変動を抑えつつ、異なる顔のサイズや画像解像度に対応します。

### 仕様
- **目標**：
  - サングラス装着時：信頼度を下げる（例: 30%減）。
  - 目の開閉状態：信頼度に影響を与えない。
  - ROIサイズ：目の開閉による変動を抑え、顔のスケールに基づいて動的に決定。
  - 輝度分析：目のROIの輝度（ピクセル値の平均）を使用し、サングラスを検出。
- **アプローチ**：
  - ROIを目のランドマークの中心を基準に、目と目の距離や目の幅に基づいて動的にサイズを設定。
  - 輝度計算前にROIを固定サイズにリサイズして一貫性を確保。
  - 環境光の影響を軽減するため、顔全体の輝度で正規化（オプション）。
  - 複数フレームの平均輝度を使用してノイズを軽減。

### 最終変更案（コード実装）

以下は、`eye_detection.py`に統合可能な最終コード例です。MediaPipeのランドマークを想定していますが、dlibなど他のライブラリにも適応可能です。

```python
import cv2
import numpy as np

# 動的ROI抽出関数
def extract_eye_roi_dynamic(image, landmarks, eye_indices, face_landmarks, scale_factor=1.5):
    if not landmarks or not face_landmarks:
        return None
    
    # 目のランドマーク座標を取得
    eye_points = [landmarks[i] for i in eye_indices]
    x_coords = [p[0] for p in eye_points]
    y_coords = [p[1] for p in eye_points]
    
    # 目の幅を計算
    eye_width = max(x_coords) - min(x_coords)
    
    # 顔のスケール（例: 目と目の距離）を計算（MediaPipeの例: 左目中心33, 右目中心263）
    left_eye_center = landmarks[33]
    right_eye_center = landmarks[263]
    inter_eye_distance = np.linalg.norm(np.array(left_eye_center) - np.array(right_eye_center))
    
    # ROIサイズを動的に決定（目と目の距離を基準にスケール）
    roi_width = int(inter_eye_distance * scale_factor * 0.5)  # 目と目の距離の半分程度
    roi_height = int(roi_width * 0.6)  # 縦は幅の0.6倍（目の形状を考慮）
    
    # 目の中心を計算
    x_center = int(np.mean(x_coords))
    y_center = int(np.mean(y_coords))
    
    # ROIを計算（画像範囲内に収まるよう調整）
    x_min = max(0, x_center - roi_width // 2)
    x_max = min(image.shape[1], x_center + roi_width // 2)
    y_min = max(0, y_center - roi_height // 2)
    y_max = min(image.shape[0], y_center + roi_height // 2)
    
    # ROIを切り出し
    eye_roi = image[y_min:y_max, x_min:x_max]
    return eye_roi

# 輝度分析によるサングラス検出（リサイズで正規化）
def check_sunglasses(eye_roi, target_size=(50, 50)):
    if eye_roi is None or eye_roi.size == 0:
        return False
    # ROIを固定サイズにリサイズ
    resized_roi = cv2.resize(eye_roi, target_size, interpolation=cv2.INTER_AREA)
    gray = cv2.cvtColor(resized_roi, cv2.COLOR_BGR2GRAY)
    brightness = np.mean(gray)
    threshold = 50  # 閾値はリサイズ後の画像で調整
    return brightness < threshold

# 複数フレームでの輝度分析（オプション）
def check_sunglasses_multi_frame(image, landmarks, eye_indices, face_landmarks, num_frames=5):
    brightness_values = []
    for _ in range(num_frames):
        eye_roi = extract_eye_roi_dynamic(image, landmarks, eye_indices, face_landmarks)
        if eye_roi is not None and eye_roi.size > 0:
            resized_roi = cv2.resize(eye_roi, (50, 50), interpolation=cv2.INTER_AREA)
            gray = cv2.cvtColor(resized_roi, cv2.COLOR_BGR2GRAY)
            brightness_values.append(np.mean(gray))
    if not brightness_values:
        return False
    average_brightness = np.mean(brightness_values)
    return average_brightness < 50

# 信頼度調整関数
def adjust_confidence(original_confidence, eye_roi):
    if check_sunglasses(eye_roi):
        return original_confidence * 0.7  # サングラス装着時に信頼度を30%下げる
    return original_confidence

# 目の検出関数（既存コードに統合）
def detect_eyes(image, landmarks, face_landmarks):
    # 左目のROIを抽出（MediaPipeのインデックス例）
    left_eye_indices = [33, 160, 158, 133, 153, 144]
    eye_roi = extract_eye_roi_dynamic(image, landmarks, left_eye_indices, face_landmarks)
    
    # 仮の信頼度計算（既存関数を想定）
    original_confidence = calculate_confidence(eye_roi)
    
    # 信頼度を調整
    adjusted_confidence = adjust_confidence(original_confidence, eye_roi)
    
    return adjusted_confidence, eye_roi
```

### 実装のポイント
1. **動的ROIサイズ**：
   - 目と目の距離（`inter_eye_distance`）を基準にROIの幅を決定（`scale_factor=1.5`で調整）。
   - 縦横比（例: `roi_height = roi_width * 0.6`）は目の形状を考慮し、開閉による高さの変動を吸収。
   - 顔のスケールに応じてROIが適応的に変化するため、異なる解像度や顔の大きさに対応。

2. **輝度分析の安定化**：
   - ROIを固定サイズ（例: 50x50）にリサイズして輝度を計算（`check_sunglasses`）。これにより、ROIサイズの違いによる輝度のばらつきを排除。
   - 複数フレームの平均輝度（`check_sunglasses_multi_frame`）をオプションで使用し、ノイズを軽減。

3. **目の開閉の無視**：
   - 目のランドマークの中心を使用し、ROIサイズは目と目の距離に基づくため、目の開閉による上下の変動の影響を最小限に。
   - 信頼度調整はサングラス検出（輝度）の結果のみに依存。

4. **エラー処理**：
   - ROIが無効（`None`や空）の場合、サングラスなしとして信頼度を変更しない。
   - ランドマークが取得できない場合も同様にフォールバック。

### 追加の最適化（オプション）
- **顔全体の輝度で正規化**：
  環境光の影響を軽減するため、目のROIの輝度を顔全体の輝度で正規化。
  ```python
  def check_sunglasses_adaptive(eye_roi, face_roi, target_size=(50, 50)):
      if eye_roi is None or face_roi is None or eye_roi.size == 0:
          return False
      resized_eye = cv2.resize(eye_roi, target_size, interpolation=cv2.INTER_AREA)
      resized_face = cv2.resize(face_roi, target_size, interpolation=cv2.INTER_AREA)
      eye_gray = cv2.cvtColor(resized_eye, cv2.COLOR_BGR2GRAY)
      face_gray = cv2.cvtColor(resized_face, cv2.COLOR_BGR2GRAY)
      relative_brightness = np.mean(eye_gray) / np.mean(face_gray)
      return relative_brightness < 0.6  # 相対輝度の閾値
  ```
  - `face_roi`は顔全体の矩形（例: MediaPipeの全ランドマークを囲む領域）。

- **スケールファクターの調整**：
  - `scale_factor=1.5`は画像解像度や顔のサイズに応じて調整（例: 高解像度なら1.2、低解像度なら1.8）。
  - テスト時にROIが目の領域を適切にカバーするか確認。

### テストと検証
- **ROIの安定性**：
  - 目を開いた/閉じた状態でROIを可視化し、サイズと位置が一貫しているか確認。
    ```python
    eye_roi = extract_eye_roi_dynamic(image, landmarks, left_eye_indices, face_landmarks)
    cv2.imshow("Dynamic ROI", eye_roi)
    cv2.waitKey(0)
    ```
- **輝度閾値の調整**：
  - サングラスあり（輝度例: 30～50）、なし（輝度例: 80～100）の画像でテストし、閾値（`50`や`0.6`）を決定。
  - 例: `check_sunglasses`で輝度値をログ出力。
    ```python
    gray = cv2.cvtColor(cv2.resize(eye_roi, (50, 50)), cv2.COLOR_BGR2GRAY)
    print(f"Brightness: {np.mean(gray)}")
    ```
- **テストケース**：
  - サングラス着用（目を開く/閉じる）：信頼度が30%低下。
  - サングラスなし（目を開く/閉じる）：信頼度が変化しない。
  - 異なる顔のサイズや解像度：ROIが適切にスケールし、輝度分析が安定。

### 注意点
- **ランドマークの精度**：
  - MediaPipeやdlibのランドマークが不正確な場合、ROIの中心がずれる。複数フレームで平均化して安定化。
- **環境光**：
  - 暗い環境では輝度が低くなるため、相対輝度（`check_sunglasses_adaptive`）の使用を推奨。
- **スケールファクター**：
  - `scale_factor`や`roi_height`の比率（`0.6`）は、実際のデータでテストして最適化。
- **パフォーマンス**：
  - ROIリサイズや複数フレーム処理は計算コストが増えるため、リアルタイム用途では`num_frames`を小さく（例: 3）。

### 最終コードの統合例
`eye_detection.py`の`detect_eyes`関数を以下のように更新：

```python
def detect_eyes(image, landmarks, face_landmarks):
    left_eye_indices = [33, 160, 158, 133, 153, 144]  # MediaPipeの左目インデックス
    eye_roi = extract_eye_roi_dynamic(image, landmarks, left_eye_indices, face_landmarks)
    
    original_confidence = calculate_confidence(eye_roi)  # 既存の信頼度計算
    adjusted_confidence = adjust_confidence(original_confidence, eye_roi)
    
    return adjusted_confidence, eye_roi
```

この変更案で、ROIサイズを動的に設定し、目の開閉の影響を排除しつつ、サングラス装着時のみ信頼度を下げられます。テストや実装の詳細（例: ランドマークの形式、解像度、閾値調整）でサポートが必要な場合、教えてください！