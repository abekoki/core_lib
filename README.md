# 動画分析システム（DataWareHouse統合版）

## 概要
動画ファイルから顔検出結果をCSV出力するシステムです。DataWareHouseデータベースと統合され、動画ファイルの管理、分析結果の保存、データベースへの登録が自動化されています。

## 新機能（2025-08-20更新）

### DataWareHouse統合
- **データベース連携**: SQLiteデータベースから動画ファイル情報を自動取得
- **結果管理**: 分析結果を構造化してデータベースに保存
- **バージョン管理**: コアライブラリのバージョン情報を自動追跡

### 出力ディレクトリ構造の改善
- **新しい構造**: `"バージョン/video_ID"`形式
- **例**: `02_core_lib_output/v1.0.0/1/`
- **クロスプラットフォーム対応**: Linux互換のパス区切り文字（`/`）を使用

### デバッグ機能の強化
- **詳細ログ**: 処理の各段階でのデバッグ情報出力
- **エラー追跡**: エラー発生時の詳細なトレースバック表示
- **処理状況**: リアルタイムでの進捗と状態表示

## システム要件

### 必須環境
- Python 3.8以上
- Windows 10/11（開発環境）
- uv（Pythonパッケージ管理）

### 必要なPythonパッケージ
- opencv-python
- mediapipe
- numpy
- scipy

### データベース
- SQLite3（DataWareHouse統合）
- 事前にセットアップされたDataWareHouseデータベース

## 環境セットアップ

### 1. 仮想環境の作成とアクティベート
```bash
# 仮想環境の作成
uv venv

# 仮想環境のアクティベート
.venv\Scripts\Activate.ps1
```

### 2. 依存関係のインストール
```bash
uv pip install -r requirements.txt
```

### 3. 設定ファイルの確認
`config.ini`で以下の設定を確認：
- DataWareHouseデータベースのパス
- 出力ディレクトリの設定
- コアライブラリのバージョン情報

## 使用方法

### 基本的な使用方法
```bash
# 仮想環境をアクティベート
.venv\Scripts\Activate.ps1

# 動画分析の実行
python video_analysis.py
```

### 処理フロー
1. **データベース接続**: DataWareHouseデータベースに接続
2. **動画情報取得**: 登録済みの動画ファイル一覧を取得
3. **分析実行**: 各動画ファイルに対して顔検出・分析を実行
4. **結果保存**: CSVファイルとデバッグ動画を保存
5. **データベース更新**: 分析結果をデータベースに登録

### 出力ファイル
- **CSVファイル**: フレーム単位の分析結果
- **デバッグ動画**: ランドマークと検出結果を可視化した動画
- **出力場所**: `02_core_lib_output/v1.0.0/{video_ID}/`

## 設定項目

### config.ini
```ini
[DEFAULT]
# DataWareHouse設定
DWH_DATABASE_PATH = ../DataWareHouse/database.db
OUTPUT_BASE_DIR = 02_core_lib_output

# コアライブラリ設定
CORE_LIB_VERSION = 1.0.0
CORE_LIB_UPDATE_INFO = 顔検出・分析機能の統合
CORE_LIB_COMMIT_HASH = a1b2c3d4e5f6a1b2c3d4e5f6a1b2c3d4e5f6a1b2

# 出力設定
OUTPUT_DIR = analysis_results
SHOW_PREVIEW = false
PROGRESS_INTERVAL = 30

[SUNGLASSES_DETECTION]
BRIGHTNESS_THRESHOLD = 50
EYE_ROI_SCALE_FACTOR = 1.5
EYE_ROI_TARGET_SIZE = 50,50
MULTI_FRAME_COUNT = 3
```

## 分析結果の内容

### CSV出力項目
- **基本情報**: フレーム番号、信頼度
- **目の状態**: 左右の開瞼度
- **顔の向き**: Yaw（左右）、Pitch（上下）
- **サングラス検出**: 輝度ベースの検出結果
- **ランドマーク位置**: 3D座標（x, y, z）
- **幾何学的特徴**: 三角形面積、目の距離など

### デバッグ動画の内容
- 顔のランドマーク表示
- 目のROI領域の可視化
- 顔の向きを示す矢印
- リアルタイムの検出情報

## DataWareHouse統合の利点

### データ管理
- **一元化**: 動画ファイルと分析結果の一元管理
- **追跡性**: バージョンとコミットハッシュによる変更追跡
- **構造化**: 標準化されたデータ形式での保存

### 分析ワークフロー
- **自動化**: データベースからの動画取得と結果保存の自動化
- **再現性**: 分析条件と結果の完全な記録
- **拡張性**: 新しい分析アルゴリズムの追加が容易

## トラブルシューティング

### よくある問題

#### 1. DataWareHouse接続エラー
```
エラー: Database file not found: database.db
```
**解決方法**: `config.ini`の`DWH_DATABASE_PATH`を確認

#### 2. 動画ファイルが見つからない
```
警告: 動画ファイルが見つかりません
```
**解決方法**: データベースに動画ファイルが正しく登録されているか確認

#### 3. モジュールインポートエラー
```
エラー: eye_detectionモジュールのインポート失敗
```
**解決方法**: 仮想環境がアクティベートされているか確認

### デバッグモード
デバッグ出力を有効にするには：
```python
DEBUG_MODE = True  # video_analysis.py内
```

## 開発者向け情報

### アーキテクチャ
- **4層構造**: Interface, Analytics, Version Management, Data Management
- **モジュール化**: 機能別の関数分割
- **エラーハンドリング**: 包括的な例外処理

### 拡張ポイント
- **新しい分析アルゴリズム**: `eye_detection.py`に機能追加
- **出力形式**: CSV以外の形式への対応
- **データベース**: 他のデータベースシステムへの対応

## 更新履歴

### 2025-08-20
- DataWareHouse統合の実装完了
- 出力ディレクトリ構造の改善
- デバッグ機能の強化
- クロスプラットフォーム対応の実現

### 2025-07-31
- 初期バージョンのリリース
- 基本的な顔検出・分析機能
- CSV出力とデバッグ動画生成

## ライセンス
このプロジェクトはMITライセンスの下で公開されています。

## サポート
技術的な質問や問題がございましたら、開発チームまでお問い合わせください。
