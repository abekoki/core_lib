# Eye Detection and Face Pose Estimation

リアルタイムでの目の検出と顔の向き推定を行うPythonライブラリです。MediaPipeを使用して、瞼間距離と鼻の長さによる開瞼度と顔の3次元姿勢（ヨー、ピッチ、ロール）を同時に測定します。

## 機能

- **開瞼度検出**: 瞼間距離と鼻の長さによる開瞼状態の測定
- **顔の向き推定**: 3次元姿勢角（ヨー、ピッチ、ロール）の計算
- **信頼度評価**: 検出結果の信頼度スコアの算出
- **リアルタイム処理**: ウェブカメラからのリアルタイム映像処理
- **色分け表示**: 各指標で使用するランドマークの視覚的強調表示

## 必要なライブラリ

```bash
pip install opencv-python
pip install mediapipe
pip install numpy
pip install scipy
```

## 使用方法

```bash
python eye_detection.py
```

- `q`キーで終了
- ウェブカメラが必要です

## 各指標の定義

### 1. 開瞼度（Eye Opening Ratio）

瞼間の距離と鼻の長さを使用して開瞼状態を数値化した指標です。

**計算式:**
```
開瞼度 = 瞼間距離 / 鼻の長さ
```

**パラメータ:**
- **瞼間距離**: 上まぶたから下まぶたまでの垂直距離
- **鼻の長さ**: 鼻根から鼻先までの距離（正規化基準）

**値の意味:**
- **0.0**: 完全に閉眼
- **0.1-0.3**: 通常の開眼状態
- **0.3以上**: 大きく開眼

**ランドマークインデックス:**
- **左目上まぶた**: インデックス 159
- **左目下まぶた**: インデックス 145
- **右目上まぶた**: インデックス 386
- **右目下まぶた**: インデックス 374
- **鼻根**: インデックス 168
- **鼻先**: インデックス 1

**特徴:**
- 顔の大きさやカメラからの距離に依存しない
- 鼻の長さで正規化することで個人差を吸収
- より直感的で安定した指標

### 2. 顔の向き角度

#### Yaw（ヨー角）
- **定義**: 左右の回転角度
- **範囲**: -90° ～ +90°
- **正の値**: 右向き
- **負の値**: 左向き
- **0°**: 正面方向

#### Pitch（ピッチ角）
- **定義**: 上下の回転角度
- **範囲**: -45° ～ +45°
- **正の値**: 上向き
- **負の値**: 下向き
- **0°**: 正面方向

#### Roll（ロール角）
- **定義**: 頭の傾き角度
- **範囲**: -45° ～ +45°
- **正の値**: 右に傾く
- **負の値**: 左に傾く
- **0°**: 水平

### 3. 信頼度（Confidence）

検出結果の信頼性を表す指標です。

**計算方法:**
```
confidence = (stability + rotation_stability) / 2.0
```

**構成要素:**
- **stability**: 主要ランドマークのx, y座標の安定性
- **rotation_stability**: 回転ベクトルの大きさによる姿勢安定性

**値の意味:**
- **0.7-1.0**: 良好な条件（高信頼度）
- **0.4-0.7**: 普通の条件（中程度の信頼度）
- **0.0-0.4**: 悪い条件（低信頼度、遮蔽、急激な動き）

## 技術詳細

### 使用アルゴリズム

1. **MediaPipe Face Mesh**: 468個の顔ランドマーク検出
2. **PnP (Perspective-n-Point)**: 3次元姿勢推定（SOLVEPNP_ITERATIVE）
3. **オイラー角計算**: XYZ順序での回転行列分解

### ランドマークポイント

#### 開瞼度計算用
- **左目上まぶた**: インデックス 159
- **左目下まぶた**: インデックス 145
- **右目上まぶた**: インデックス 386
- **右目下まぶた**: インデックス 374
- **鼻根**: インデックス 168
- **鼻先**: インデックス 1

#### 顔の向き推定用
- **鼻先**: インデックス 1
- **顎**: インデックス 152
- **左目**: インデックス 33
- **右目**: インデックス 263
- **左口角**: インデックス 61
- **右口角**: インデックス 291

### 座標系

- **画像座標系**: 左上が原点 (0,0)
- **3D座標系**: カメラ中心が原点
- **角度座標系**: カメラ正面方向が0度

### 色分け表示

- **緑色**: 開瞼度計算用ランドマーク
- **青色**: 顔の向き推定用ランドマーク
- **赤色**: 信頼度計算用ランドマーク

## 表示情報

リアルタイムで以下の情報が表示されます：

1. **Left Eye Opening**: 左目の開瞼度（鼻の長さに対する比率）
2. **Right Eye Opening**: 右目の開瞼度（鼻の長さに対する比率）
3. **Nose Length**: 鼻の長さ（ピクセル単位）
4. **Confidence**: 信頼度スコア
5. **Yaw/Pitch/Roll**: 顔の向き角度（度単位）

## 応用例

- **ドライバー監視システム**: 居眠り検出
- **視線追跡**: 視線方向の推定
- **表情認識**: 感情分析の前処理
- **VR/AR**: ヘッドトラッキング
- **アクセシビリティ**: 視線による操作
- **疲労検出**: 長時間の作業における疲労度測定

## 注意事項

- 十分な照明が必要です
- 顔がカメラに正対している必要があります
- メガネやマスクは精度に影響する可能性があります
- リアルタイム処理のため、高性能なCPU/GPUを推奨します
- 急激な頭の動きは信頼度を低下させます

## 更新履歴

- **v2.0**: 開瞼度を瞼間距離と鼻の長さによる再定義
- **v2.1**: オイラー角計算の修正（yaw/pitchの出力順序修正）
- **v2.2**: 信頼度計算の改善（より実用的な評価方法）

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。
